version: '3.8'

services:
  gcli2api:
    build: .  # <-- 修改这里：使用当前目录的 Dockerfile 来构建镜像
    image: gcli2api:local
    container_name: gcli2api
    restart: unless-stopped
    # network_mode: host  <-- 删除或注释掉这一行
    ports:
      - "7881:7861" 

    environment:
      # 使用通用密码（推荐用于简单部署）
      - PORT=7861
      # 或使用分离密码（推荐用于生产环境）
      - API_PASSWORD=
      - PANEL_PASSWORD=
      - GOOGLE_API_KEY=
      
    volumes:
      - ./data/creds:/app/creds
    healthcheck:
      test: ["CMD-SHELL", "python -c \"import sys, urllib.request, os; port = os.environ.get('PORT', '7861'); req = urllib.request.Request(f'http://localhost:{port}/v1/models', headers={'Authorization': 'Bearer ' + os.environ.get('PASSWORD', 'pwd')}); sys.exit(0 if urllib.request.urlopen(req, timeout=5).getcode() == 200 else 1)\""]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s
